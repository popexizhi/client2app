# -*- coding -*-
from githook_web import json_git 
import unittest

class TestGitHook(unittest.TestCase):

    def test_get_files(self):
        d = {'project_id': 2, 'user_id': 5, 'object_kind': 'push', 'repository': {'git_ssh_url': 'git@192.168.1.33:nexus/Nexus.git', 'name': 'Nexus', 'url': 'git@192.168.1.33:nexus/Nexus.git', 'git_http_url': 'http://192.168.1.33/nexus/Nexus.git', 'visibility_level': 0, 'homepage': 'http://192.168.1.33/nexus/Nexus', 'description': ''}, 'user_name': 'lijie', 'after': 'ad8d7a8eccbff8449e333839cdcd4b311331598e', 'project': {'git_ssh_url': 'git@192.168.1.33:nexus/Nexus.git', 'path_with_namespace': 'nexus/Nexus', 'name': 'Nexus', 'avatar_url': None, 'url': 'git@192.168.1.33:nexus/Nexus.git', 'default_branch': 'master', 'namespace': 'Nexus Project', 'git_http_url': 'http://192.168.1.33/nexus/Nexus.git', 'web_url': 'http://192.168.1.33/nexus/Nexus', 'ssh_url': 'git@192.168.1.33:nexus/Nexus.git', 'http_url': 'http://192.168.1.33/nexus/Nexus.git', 'visibility_level': 0, 'homepage': 'http://192.168.1.33/nexus/Nexus', 'description': ''}, 'total_commits_count': 3, 'commits': [{'added': [], 'author': {'name': 'liguopeng', 'email': 'liguopeng@senlime.com'}, 'url': 'http://192.168.1.33/nexus/Nexus/commit/ad8d7a8eccbff8449e333839cdcd4b311331598e', 'timestamp': '2016-08-05T11:30:33+00:00', 'modified': ['tools/ci/action/nexustest.py'], 'message': u"fix bug: ci scripts, didn't create all device db\n", 'removed': [], 'id': 'ad8d7a8eccbff8449e333839cdcd4b311331598e'}, {'added': [], 'author': {'name': 'liguopeng', 'email': 'liguopeng@senlime.com'}, 'url': 'http://192.168.1.33/nexus/Nexus/commit/a2ef1fd65e7db6c9f324aae0b1260ca16c32240d', 'timestamp': '2016-08-05T11:22:44+00:00', 'modified': ['Dev88Test/Dev88Test.py', 'tools/ci/action/nexustest.py'], 'message': 'ci scripts: add run_time opt\n', 'removed': [], 'id': 'a2ef1fd65e7db6c9f324aae0b1260ca16c32240d'}, {'added': [], 'author': {'name': 'hex', 'email': 'hexu@senlime.com'}, 'url': 'http://192.168.1.33/nexus/Nexus/commit/365a713bbbb81b93c1b5f7cdc2fefdc87275152f', 'timestamp': '2016-08-05T11:12:34+00:00', 'modified': ['Dev88Test/Dev88Test.py', 'tools/ci/action/nexustest.py', 'tools/ci/deploy/npl.db', 'tools/ci/deploy/nplServer.db', 'tools/ci/nexus/noc/relay.py', 'tools/ci/nexus/sqlitemgr.py'], 'message': u"Merge branch 'dev88' of 192.168.1.33:nexus/Nexus into dev88\n", 'removed': [], 'id': '365a713bbbb81b93c1b5f7cdc2fefdc87275152f'}], 'user_avatar': 'http://192.168.1.33/uploads/user/avatar/5/ul1947743-2.jpg', 'message': None, 'before': '365a713bbbb81b93c1b5f7cdc2fefdc87275152f', 'ref': 'refs/heads/master', 'user_email': 'lijie@senlime.com', 'checkout_sha': 'ad8d7a8eccbff8449e333839cdcd4b311331598e'}
        files, commit_list = self.get_files(d)
        pre_files = ['tools/ci/action/nexustest.py', 'Dev88Test/Dev88Test.py', 'tools/ci/action/nexustest.py', 'Dev88Test/Dev88Test.py', 'tools/ci/action/nexustest.py', 'tools/ci/deploy/npl.db', 'tools/ci/deploy/nplServer.db', 'tools/ci/nexus/noc/relay.py', 'tools/ci/nexus/sqlitemgr.py']
        pre_commit_list = ['ad8d7a8eccbff8449e333839cdcd4b311331598e','a2ef1fd65e7db6c9f324aae0b1260ca16c32240d', '365a713bbbb81b93c1b5f7cdc2fefdc87275152f']
        self.assertEqual(pre_files, files)
        self.assertEqual(pre_commit_list, commit_list)

    def test_get_branch(self):
        d = {'project_id': 2, 'user_id': 5, 'object_kind': 'push', 'repository': {'git_ssh_url': 'git@192.168.1.33:nexus/Nexus.git', 'name': 'Nexus', 'url': 'git@192.168.1.33:nexus/Nexus.git', 'git_http_url': 'http://192.168.1.33/nexus/Nexus.git', 'visibility_level': 0, 'homepage': 'http://192.168.1.33/nexus/Nexus', 'description': ''}, 'user_name': 'lijie', 'after': 'ad8d7a8eccbff8449e333839cdcd4b311331598e', 'project': {'git_ssh_url': 'git@192.168.1.33:nexus/Nexus.git', 'path_with_namespace': 'nexus/Nexus', 'name': 'Nexus', 'avatar_url': None, 'url': 'git@192.168.1.33:nexus/Nexus.git', 'default_branch': 'master', 'namespace': 'Nexus Project', 'git_http_url': 'http://192.168.1.33/nexus/Nexus.git', 'web_url': 'http://192.168.1.33/nexus/Nexus', 'ssh_url': 'git@192.168.1.33:nexus/Nexus.git', 'http_url': 'http://192.168.1.33/nexus/Nexus.git', 'visibility_level': 0, 'homepage': 'http://192.168.1.33/nexus/Nexus', 'description': ''}, 'total_commits_count': 3, 'commits': [{'added': [], 'author': {'name': 'liguopeng', 'email': 'liguopeng@senlime.com'}, 'url': 'http://192.168.1.33/nexus/Nexus/commit/ad8d7a8eccbff8449e333839cdcd4b311331598e', 'timestamp': '2016-08-05T11:30:33+00:00', 'modified': ['tools/ci/action/nexustest.py'], 'message': u"fix bug: ci scripts, didn't create all device db\n", 'removed': [], 'id': 'ad8d7a8eccbff8449e333839cdcd4b311331598e'}, {'added': [], 'author': {'name': 'liguopeng', 'email': 'liguopeng@senlime.com'}, 'url': 'http://192.168.1.33/nexus/Nexus/commit/a2ef1fd65e7db6c9f324aae0b1260ca16c32240d', 'timestamp': '2016-08-05T11:22:44+00:00', 'modified': ['Dev88Test/Dev88Test.py', 'tools/ci/action/nexustest.py'], 'message': 'ci scripts: add run_time opt\n', 'removed': [], 'id': 'a2ef1fd65e7db6c9f324aae0b1260ca16c32240d'}, {'added': [], 'author': {'name': 'hex', 'email': 'hexu@senlime.com'}, 'url': 'http://192.168.1.33/nexus/Nexus/commit/365a713bbbb81b93c1b5f7cdc2fefdc87275152f', 'timestamp': '2016-08-05T11:12:34+00:00', 'modified': ['Dev88Test/Dev88Test.py', 'tools/ci/action/nexustest.py', 'tools/ci/deploy/npl.db', 'tools/ci/deploy/nplServer.db', 'tools/ci/nexus/noc/relay.py', 'tools/ci/nexus/sqlitemgr.py'], 'message': u"Merge branch 'dev88' of 192.168.1.33:nexus/Nexus into dev88\n", 'removed': [], 'id': '365a713bbbb81b93c1b5f7cdc2fefdc87275152f'}], 'user_avatar': 'http://192.168.1.33/uploads/user/avatar/5/ul1947743-2.jpg', 'message': None, 'before': '365a713bbbb81b93c1b5f7cdc2fefdc87275152f', 'ref': 'refs/heads/master', 'user_email': 'lijie@senlime.com', 'checkout_sha': 'ad8d7a8eccbff8449e333839cdcd4b311331598e'}
        get_branch = json_git(d).get_branch()
        pre_branch = "refs/heads/master"
        self.assertEqual(get_branch, pre_branch)

    def get_files(self, src):
        x = json_git(src)
        return x.get_files()

if __name__ == '__main__':
    unittest.main()
